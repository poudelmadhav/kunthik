#!/bin/bash -e

# Wait for Postgres if DATABASE_URL points to a TCP host
wait_for_db() {
  if [[ -n "${DATABASE_URL}" ]]; then
    host=$(echo "$DATABASE_URL" | sed -E 's#^.+://[^:@]+(:[^@]+)?@([^:/]+).*$#\2#')
    port=$(echo "$DATABASE_URL" | sed -E 's#^.+://[^:@]+(:[^@]+)?@[^:/]+:([0-9]+).*$#\2#')
    [[ -z "$port" ]] && port=5432
    if [[ -n "$host" ]]; then
      echo "Waiting for Postgres at $host:$port..."
      for i in {1..30}; do
        if /usr/bin/pg_isready -h "$host" -p "$port" -q; then
          echo "Postgres is ready."; break
        fi
        sleep 1
      done
    fi
  fi
}

# If running the rails server, prepare database (create + migrate)
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  wait_for_db
  ./bin/rails db:prepare
fi

exec "$@"
